name: Build ZMK firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
  
  package:
    runs-on: ubuntu-latest
    needs: build
    name: Package firmware with commit info
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Create commit info file
      run: |
        echo "ZMK Firmware Build Information" > commit_info.txt
        echo "=============================" >> commit_info.txt
        echo "Commit SHA: ${{ github.sha }}" >> commit_info.txt
        echo "Short SHA: ${GITHUB_SHA:0:7}" >> commit_info.txt
        echo "Branch: ${{ github.ref_name }}" >> commit_info.txt
        echo "Commit Message: $(git log -1 --pretty=format:'%s')" >> commit_info.txt
        echo "Commit Author: $(git log -1 --pretty=format:'%an <%ae>')" >> commit_info.txt
        echo "Commit Date: $(git log -1 --pretty=format:'%ci')" >> commit_info.txt
        echo "Build Date: $(date -u)" >> commit_info.txt
        echo "Repository: ${{ github.repository }}" >> commit_info.txt
        echo "Workflow Run: ${{ github.run_number }}" >> commit_info.txt
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "PR Number: ${{ github.event.number }}" >> commit_info.txt
        fi
        echo "" >> commit_info.txt
        echo "Boards built: levels54_left, levels54_right" >> commit_info.txt
        echo "Studio enabled on: levels54_left" >> commit_info.txt
        echo "" >> commit_info.txt
        echo "This firmware was built from commit ${{ github.sha }}" >> commit_info.txt
        cat commit_info.txt
    
    - name: Download firmware artifacts
      uses: actions/download-artifact@v4
      with:
        path: firmware-artifacts
    
    - name: List downloaded artifacts
      run: find firmware-artifacts -type f -name "*.uf2" -o -name "*.hex"
    
    - name: Create firmware package
      run: |
        mkdir firmware-package
        
        # Copy all firmware files
        find firmware-artifacts -name "*.uf2" -exec cp {} firmware-package/ \;
        find firmware-artifacts -name "*.hex" -exec cp {} firmware-package/ \;
        
        # Add commit info
        cp commit_info.txt firmware-package/
        
        # Create README
        echo "ZMK Firmware Package" > firmware-package/README.txt
        echo "===================" >> firmware-package/README.txt
        echo "" >> firmware-package/README.txt
        echo "This package contains:" >> firmware-package/README.txt
        echo "- levels54_left.uf2 (with ZMK Studio support)" >> firmware-package/README.txt
        echo "- levels54_right.uf2" >> firmware-package/README.txt
        echo "- commit_info.txt (build details)" >> firmware-package/README.txt
        echo "- This README file" >> firmware-package/README.txt
        echo "" >> firmware-package/README.txt
        echo "Flash the .uf2 files to your keyboard halves." >> firmware-package/README.txt
        
        # List contents
        echo "Package contents:"
        ls -la firmware-package/
    
    - name: Upload complete firmware package
      uses: actions/upload-artifact@v4
      with:
        name: levels54-firmware-package
        path: firmware-package/